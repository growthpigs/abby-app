# Technical Debt Registry

> Captured 2026-01-15 | MVP Phase | Review for V2

This document tracks known fragile code patterns identified during the MVP build. These are NOT bugs - they're architectural shortcuts that work correctly but could break during future development.

## Severity Guide

| Level | Meaning | Action |
|-------|---------|--------|
| CRITICAL | Could break silently during demo | Fixed with safeguards |
| HIGH | Could regress during active development | Needs tests before V2 |
| MEDIUM | Technical debt for V2 | Document and defer |

---

## CRITICAL (Safeguards Added)

### 1. Shader Morph Regex Brittleness
**File:** `src/shaders/morphWrapper.ts:141-162`
**Issue:** Regex parsing shader return statements fails silently if format changes
**Safeguard Added:** Dev warning now fires if morph injection fails (line 164-173)
**V2 Fix:** Replace regex with proper shader AST parsing or validator

### 2. useClock Dependency Array Workaround
**File:** `src/components/layers/VibeMatrixAnimated.tsx:102-113`
**Issue:** Animation depends on react-native-reanimated bug (GitHub #2640)
**Safeguard Added:** Pinned `react-native-reanimated` to exact version 4.1.6
**V2 Fix:** Monitor library releases for proper fix, then remove workaround

### 3. Dual State Stores (VibeStore vs VibeController)
**Files:** `src/store/useVibeStore.ts`, `src/store/useVibeController.ts`
**Issue:** Two stores manage overlapping state with no synchronization
**Status:** **DOWNGRADED** - `useVibeStore` is actually dead code (never imported)
**Safeguard Added:** Dev warning + @deprecated JSDoc as tripwire if anyone uses it
**V2 Fix:** Delete `useVibeStore.ts` entirely

---

## HIGH (Needs Tests Before V2)

### 4. Implicit State Dependencies
**File:** `src/store/useVibeController.ts:241-261`
**Issue:** `setColorTheme()` reads `complexity` via `get()` - race condition possible
**Test Needed:** Concurrent call test for `setColorTheme()` + `setComplexity()`

### 5. Token Refresh Mutex Edge Case
**File:** `src/services/AuthService.ts:151-388`
**Issue:** Mutex can be bypassed if code calls `_doRefreshToken()` directly
**Test Needed:** Integration test for concurrent token refresh

### 6. Mock/Real API Switch
**File:** `src/services/api/index.ts:19-31`
**Issue:** Missing env var silently falls back to mock API
**Test Needed:** CI check that `EXPO_PUBLIC_USE_REAL_API` is set in prod builds

### 7. Cognito Credentials Duplication
**Files:** `src/services/CognitoConfig.ts:18-21`, `src/config.ts:49-52`
**Issue:** Credentials hardcoded in two places
**V2 Fix:** Move to env vars, single source of truth

### 8. AbbyOrb Coordinate Transforms
**File:** `src/components/layers/AbbyOrb/index.tsx:53-78`
**Issue:** UV/screen coordinate conversion duplicated manually
**Test Needed:** Orientation change test for tap hitbox alignment

---

## MEDIUM (Document for V2)

### 9. Hardcoded Shader Animation Ranges
**File:** `src/shaders/factory/effects/domainWarp.ts:36-38`
**Issue:** Speed `mix(0.15, 0.5, ...)` not calibrated to frame rate
**Note:** Works fine, but may need tuning for different devices

### 10. JWT Decode Silent Failure
**File:** `src/services/AuthService.ts:98-110`
**Issue:** Returns `null` on any parse error without distinction
**Note:** Triggers unnecessary refresh but doesn't break auth

### 11. 30-Second Refresh Timeout
**File:** `src/services/AuthService.ts:127-144`
**Issue:** May be too short for slow networks
**Note:** Monitor for issues in field testing

### 12. No Retry Circuit Breaker
**File:** `src/utils/secureFetch.ts:169-245`
**Issue:** 7+ second total retry delay with no abort
**Note:** Acceptable for MVP, add circuit breaker for V2

### 13. API Error Schema Not Validated
**File:** `src/services/api/client.ts:114-130`
**Issue:** Assumes error response has `code`/`message` fields
**Note:** Works with current API, add validation for V2

### 14. Boolean Env Var Coercion
**File:** `src/config.ts:131`
**Issue:** `VOICE_ENABLED=1` becomes `false` (only `'true'` works)
**Note:** Document in README

### 15. Onboarding Version Migration
**File:** `src/store/useOnboardingStore.ts:468-488`
**Issue:** Invalid screen index silently returns first screen
**Note:** Edge case, unlikely to hit in practice

### 16. Partial Answer Submission
**File:** `src/store/useOnboardingStore.ts:331-405`
**Issue:** No rollback if some answers fail to submit
**Note:** Retry logic handles most cases

### 17. Settings Enum Validation
**File:** `src/store/useSettingsStore.ts:12-20`
**Issue:** Type cast bypasses runtime validation
**Note:** Low impact, fix when adding new input modes

---

## Review Schedule

- [ ] **Before V2 kickoff:** Review HIGH items, add tests
- [ ] **V2 Sprint 1:** Consolidate vibe stores
- [ ] **V2 Sprint 2:** Move credentials to env vars
- [ ] **V2 Sprint 3:** Add circuit breaker to API layer

---

*Generated by fragile code scan, 2026-01-15*

---

## Competitive Code Review Findings (2026-01-15)

> Two autonomous agents competed to find issues. Combined 71 findings, 4 fixed immediately.

### Fixed Today

| Issue | File | Fix |
|-------|------|-----|
| Token refresh infinite loop | `secureFetch.ts:276` | Added `skipTokenRefresh: true` to retry |
| Missing useEffect deps | `SearchingScreen.tsx:68,93` | Added all dependencies |
| Secret nav borders in prod | `SearchingScreen.tsx:199-239` | Conditional `__DEV__` borders |

### Added to Backlog

| Issue | Severity | Notes |
|-------|----------|-------|
| Unbounded `conversationHistory` | HIGH | Add 50-message sliding window |
| No AbortSignal for API cancellation | HIGH | Add to all service methods |
| POST retry causing duplicates | MEDIUM | Add idempotency keys |
| Missing HTTPS validation on TTS | LOW | Validate audio URLs |
| Internal RN API (`_value`, `_offset`) | HIGH | Fragile - monitor RN updates |
| No error boundaries for shaders | MEDIUM | Add graceful failure UI |
| Missing input sanitization | LOW | Sanitize user messages |

### Explicitly Accepted (Not Fixing)

- Hardcoded Cognito creds (works, env vars in V2)
- Battery drain from continuous canvas (demo only)
- Magic numbers (functional, cosmetic debt)
- Duplicate Answer types (low impact)
